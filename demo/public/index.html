
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection - Real Time</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Socket.io Cliente -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilos oscuros personalizados */
        body { background-color: #111827; color: #f3f4f6; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4338ca; }

        .list-container { max-height: 400px; overflow-y: auto; }
        
        /* Animaci√≥n de alerta */
        @keyframes flash-red {
            0% { background-color: rgba(220, 38, 38, 0.5); }
            100% { background-color: transparent; }
        }
        .new-alert { animation: flash-red 1.5s ease-out; }
    </style>
</head>

<body class="p-4 md:p-8 font-sans">

    <!-- HEADER -->
    <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <div>
            <h2 class="text-3xl font-bold text-indigo-400">Monitor de Transacciones</h2>
            <p class="text-gray-500 text-sm">Conectado a Spark Streaming & Kafka</p>
        </div>
        <div class="flex gap-4">
            <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                <span class="text-gray-400 text-xs uppercase">Estado</span>
                <div id="statusIndicator" class="text-green-400 font-bold">‚óè En L√≠nea</div>
            </div>
        </div>
    </header>

    <!-- KPI CARDS -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <h4 class="text-sm font-medium text-gray-400">Transacciones Totales</h4>
            <div id="totalTx" class="text-3xl font-extrabold text-indigo-400 mt-1">0</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <h4 class="text-sm font-medium text-gray-400">Monto Promedio</h4>
            <div id="avgAmount" class="text-3xl font-extrabold text-gray-100 mt-1">$0.00</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <h4 class="text-sm font-medium text-gray-400">Alertas de Fraude</h4>
            <div id="totalAlerts" class="text-3xl font-extrabold text-red-500 mt-1">0</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <h4 class="text-sm font-medium text-gray-400">√öltimo Score Riesgo</h4>
            <div id="lastScore" class="text-3xl font-extrabold text-yellow-400 mt-1">-</div>
        </div>
    </div>

    <!-- MAIN CHARTS AREA -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Chart: Flujo en tiempo real -->
        <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <h3 class="text-xl font-semibold mb-4 text-gray-200">Flujo de Transacciones (Tiempo Real)</h3>
            <div class="h-64">
                <canvas id="flowChart"></canvas>
            </div>
        </div>
        
        <!-- Chart: Distribuci√≥n Plataforma -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <h3 class="text-xl font-semibold mb-4 text-gray-200">Plataformas</h3>
            <div class="h-64 flex justify-center">
                <canvas id="platformChart"></canvas>
            </div>
        </div>
    </div>

    <!-- LISTS AREA -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- √öltimas Transacciones -->
        <div class="lg:col-span-2">
            <h3 class="text-xl font-semibold mb-3 text-gray-200">√öltimas Transacciones</h3>
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <div class="grid grid-cols-5 bg-gray-900 p-3 text-xs text-gray-400 font-bold uppercase tracking-wider">
                    <div class="col-span-1">ID</div>
                    <div class="col-span-1">Monto</div>
                    <div class="col-span-1">Plataforma</div>
                    <div class="col-span-1">Ciudad</div>
                    <div class="col-span-1 text-right">Score</div>
                </div>
                <div id="txList" class="list-container">
                    <!-- Items inyectados por JS -->
                </div>
            </div>
        </div>

        <!-- Alertas de Fraude -->
        <div>
            <h3 class="text-xl font-semibold mb-3 text-red-400 flex items-center gap-2">
                <span>üö®</span> Registro de Alertas
            </h3>
            <div id="alertList" class="list-container bg-gray-800 rounded-xl border border-red-900/50 p-2 space-y-2">
                <!-- Alertas inyectadas por JS -->
                <div class="text-gray-500 text-center text-sm py-4 italic">Esperando alertas...</div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // 1. Conexi√≥n Socket.IO
        const socket = io('http://localhost:5000');
        
        socket.on('connect', () => {
            document.getElementById('statusIndicator').innerText = "‚óè Conectado";
            document.getElementById('statusIndicator').className = "text-green-400 font-bold";
        });

        socket.on('disconnect', () => {
            document.getElementById('statusIndicator').innerText = "‚óè Desconectado";
            document.getElementById('statusIndicator').className = "text-red-500 font-bold";
        });

        // 2. Configuraci√≥n de Gr√°ficos (Chart.js)
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        // Gr√°fico de L√≠nea (Flujo)
        const ctxFlow = document.getElementById('flowChart').getContext('2d');
        const flowChart = new Chart(ctxFlow, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Monto Tx',
                    data: [],
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false } },
                animation: { duration: 0 } // Desactivar animaci√≥n para rendimiento alto
            }
        });

        // Gr√°fico Donut (Plataforma)
        const ctxPlat = document.getElementById('platformChart').getContext('2d');
        const platformChart = new Chart(ctxPlat, {
            type: 'doughnut',
            data: {
                labels: ['App movil', 'Web', 'Sucursal', 'Cajero', 'Otros'],
                datasets: [{
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#6b7280'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // Variables globales para acumulados
        let totalTransactions = 0;
        let totalAmount = 0;
        let fraudCount = 0;

        // 3. Manejo de Datos (Eventos del Servidor)
        socket.on('new_transaction', (data) => {
            // Actualizar KPIs
            totalTransactions++;
            totalAmount += parseFloat(data.amount);
            
            document.getElementById('totalTx').innerText = totalTransactions.toLocaleString();
            document.getElementById('avgAmount').innerText = `$${(totalAmount / totalTransactions).toFixed(2)}`;
            document.getElementById('lastScore').innerText = data.score.toFixed(4);

            // Actualizar Lista de Transacciones
            const list = document.getElementById('txList');
            const item = document.createElement('div');
            // Color del score: verde si es bajo, rojo si es alto
            const scoreColor = data.score > 0.7 ? 'text-red-400' : 'text-green-400';
            
            item.className = "grid grid-cols-5 p-3 border-b border-gray-700 hover:bg-gray-700 transition-colors text-sm items-center";
            item.innerHTML = `
                <div class="col-span-1 font-mono text-gray-400 truncate">${data.id}</div>
                <div class="col-span-1 font-bold text-white">$${data.amount}</div>
                <div class="col-span-1 text-xs text-indigo-300">${data.platform}</div>
                <div class="col-span-1 text-xs text-gray-400">${data.state}</div>
                <div class="col-span-1 text-right font-bold ${scoreColor}">${data.score}</div>
            `;
            list.prepend(item);
            if (list.children.length > 15) list.lastChild.remove();

            // Actualizar Gr√°fico de Flujo
            const now = new Date().toLocaleTimeString();
            flowChart.data.labels.push(now);
            flowChart.data.datasets[0].data.push(data.amount);
            if (flowChart.data.labels.length > 20) {
                flowChart.data.labels.shift();
                flowChart.data.datasets[0].data.shift();
            }
            flowChart.update();

            // Actualizar Gr√°fico de Plataforma (Simple mapping)
            const platMap = {'App movil': 0, 'Web': 1, 'Sucursal bancaria': 2, 'Cajero automatico': 3};
            const idx = platMap[data.platform] !== undefined ? platMap[data.platform] : 4;
            platformChart.data.datasets[0].data[idx]++;
            platformChart.update();
        });

        socket.on('new_alert', (data) => {
            fraudCount++;
            const counter = document.getElementById('totalAlerts');
            counter.innerText = fraudCount;
            
            // Efecto visual en el contador
            counter.classList.add('text-white');
            setTimeout(() => counter.classList.remove('text-white'), 500);

            // Agregar a lista de alertas
            const list = document.getElementById('alertList');
            
            // Limpiar mensaje de "esperando" si existe
            if(list.innerText.includes("Esperando")) list.innerHTML = "";

            const item = document.createElement('div');
            item.className = "new-alert bg-red-900/30 border-l-4 border-red-500 p-3 rounded shadow";
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-red-400 text-sm">Posible Fraude Detectado</div>
                        <div class="text-xs text-gray-400 mt-1">ID: ${data.id}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-bold">$${data.amount}</div>
                        <div class="text-xs text-red-300 font-mono">Score: ${data.score}</div>
                    </div>
                </div>
            `;
            list.prepend(item);
            if (list.children.length > 10) list.lastChild.remove();
        });
    </script>
</body>
</html>